generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  password            String
  role                String               @default("user")
  is_active           Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  fcmToken            String?
  pushToken           String?
  device_type         String?
  Availability        Availability[]
  bookings            Booking[]            @relation("UserBookings")
  documents           Document[]
  feedbacks           Feedback[]
  inventory           Inventory[]
  sentMessages        Message[]            @relation("UserSentMessages")
  notifications       Notification[]
  promotions          Promotion[]
  reviews             Review[]             @relation("UserReviews")
  services            Service[]            @relation("VendorServices")
  userProfile         UserProfile?
  vendorProfile       VendorProfile?
  VendorPayoutAccount VendorPayoutAccount?

  @@index([email])
  @@index([role])
}

model BlacklistedToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}


model UserProfile {
  id              Int     @id @default(autoincrement())
  userId          Int     @unique
  name            String
  phone           String?
  address         String?
  profile_picture String?
  id_proof_front  String?
  id_proof_back   String?
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VendorProfile {
  id                   Int     @id @default(autoincrement())
  userId               Int     @unique
  business_name        String
  business_type        String?
  description          String?
  phone                String
  alternate_phone      String?
  email                String?
  owner_name           String?
  date_of_birth        String?
  address              String? @default("")
  street               String?
  area                 String?
  city                 String?
  state                String?
  pincode              String?
  landmark             String?
  latitude             Float?
  longitude            Float?
  gst_number           String?
  has_gst              Boolean @default(false)
  tax_type             String?
  operating_hours      String?
  breaks               String?
  holidays             String?
  status               String  @default("pending")
  onboarding_completed Boolean @default(false)
  image                String?
  cover_image          String?
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Document {
  id            Int      @id @default(autoincrement())
  vendorId      Int
  document_type String
  file_url      String
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  vendor        User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Service {
  id          Int       @id @default(autoincrement())
  vendorId    Int
  name        String
  description String
  price       Decimal
  duration    Int
  category    String
  image_url   String?
  is_active   Boolean   @default(true)
  is_featured Boolean   @default(false)
  bookings    Booking[]
  vendor      User      @relation("VendorServices", fields: [vendorId], references: [id], onDelete: Cascade)
}

model Booking {
  id           Int           @id @default(autoincrement())
  userId       Int
  serviceId    Int
  booking_date DateTime
  booking_time String
  status       String        @default("pending") // pending, confirmed, in_progress, service_completed, user_confirmed, disputed, cancelled, refunded
  vendor_status String       @default("pending") // pending, accepted, rejected
  notes        String?
  completion_images String[] @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  service      Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user         User          @relation("UserBookings", fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation?
  payment      Payment?      @relation("BookingPayment")
  review       Review?

  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@index([vendor_status])
  @@index([booking_date])
}

model Payment {
  id        Int      @id @default(autoincrement())
  bookingId Int?     @unique
  booking   Booking? @relation("BookingPayment", fields: [bookingId], references: [id], onDelete: Cascade)

  amount        Decimal
  currency      String  @default("INR")
  status        String  @default("pending") // success, failed, pending
  method        String // stripe, razorpay, cash
  transactionId String? // Gateway Payment ID

  // Vendor Payout Tracking
  vendorPayoutStatus String?  @default("pending") // pending, paid, failed, not_applicable
  vendorPayoutId     String? // External Transfer ID
  platformFee        Decimal?
  vendorAmount       Decimal?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Inventory {
  id          Int      @id @default(autoincrement())
  vendorId    Int
  item_name   String
  stock_level Int
  createdAt   DateTime @default(now())
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Availability {
  id           Int      @id @default(autoincrement())
  vendorId     Int
  day_of_week  String
  start_time   String
  end_time     String
  is_available Boolean  @default(true)
  createdAt    DateTime @default(now())
  vendor       User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Conversation {
  id        Int       @id @default(autoincrement())
  bookingId Int       @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([bookingId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       Int
  message_text   String
  sent_at        DateTime     @default(now())
  isRead         Boolean      @default(false)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("UserSentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}

model Review {
  id        Int      @id @default(autoincrement())
  bookingId Int      @unique
  userId    Int
  rating    Int
  comment   String?
  reply     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
}

model Promotion {
  id          Int      @id @default(autoincrement())
  vendorId    Int
  title       String
  description String
  discount    Float
  start_date  DateTime
  end_date    DateTime
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  is_read   Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Feedback {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  category  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailOTP {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PhoneOTP {
  id           Int      @id @default(autoincrement())
  phone_number String   @unique
  otp          String
  expiresAt    DateTime
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())
}

model VendorPayoutAccount {
  id       Int  @id @default(autoincrement())
  vendorId Int  @unique
  vendor   User @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  contactId     String // RazorpayX contact_id
  fundAccountId String // RazorpayX fund_account_id

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
