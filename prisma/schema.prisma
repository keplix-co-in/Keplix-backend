// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==============================
// 1. USERS & PROFILES
// ==============================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String   @default("user") // "user", "vendor", "admin"
  is_active Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userProfile   UserProfile?
  vendorProfile VendorProfile?

  // Service Relations
  bookings Booking[] @relation("UserBookings")
  reviews  Review[]  @relation("UserReviews")

  // Vendor Relations (Services offered by this user if they are a vendor)
  services  Service[]   @relation("VendorServices")
  inventory Inventory[]
  promotions Promotion[]

  // Chat & Notifications
  sentMessages  Message[]
  notifications Notification[]
  feedbacks     Feedback[]
  documents     Document[]
  Availability  Availability[]

  // Device Info
  fcmToken    String? // Firebase Cloud Messaging Token
  device_type String? // android, ios, web
  
  @@index([email])
  @@index([role])
}

model UserProfile {
  id      Int     @id @default(autoincrement())
  userId  Int     @unique
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name    String
  phone   String?
  address String?
}

model VendorProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  business_name String
  phone         String
  email         String?
  address       String? @default("")

  // Location
  latitude  Float?
  longitude Float?

  // Details
  gst_number      String?
  operating_hours String? // e.g. "09:00 AM - 09:00 PM"

  // Status
  status               String  @default("pending") // "pending", "approved", "rejected"
  onboarding_completed Boolean @default(false)

  image String? // URL to image
}

model Document {
  id            Int      @id @default(autoincrement())
  vendorId      Int
  vendor        User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  document_type String
  file_url      String
  status        String   @default("pending")
  createdAt     DateTime @default(now())
}

// ==============================
// 2. SERVICES & BOOKINGS
// ==============================

model Service {
  id       Int  @id @default(autoincrement())
  vendorId Int
  vendor   User @relation("VendorServices", fields: [vendorId], references: [id], onDelete: Cascade)

  name        String
  description String
  price       Decimal
  duration    Int // in minutes
  category    String
  image_url   String? // The field we aliased to 'image' in the serializer

  bookings Booking[]
}

model Booking {
  id        Int     @id @default(autoincrement())
  userId    Int
  user      User    @relation("UserBookings", fields: [userId], references: [id], onDelete: Cascade)
  serviceId Int
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  booking_date DateTime 
  booking_time String 
  status       String   @default("pending") 
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payment      Payment?
  review       Review?
  conversation Conversation?
  
  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@index([booking_date])
}

model Payment {
  id        Int     @id @default(autoincrement())
  bookingId Int     @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amount        Decimal
  status        String  @default("pending") 
  method        String
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Inventory {
  id          Int      @id @default(autoincrement())
  vendorId    Int
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  item_name   String
  stock_level Int
  createdAt   DateTime @default(now())
}

model Availability {
  id           Int      @id @default(autoincrement())
  vendorId     Int
  vendor       User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  day_of_week  String
  start_time   String
  end_time     String
  is_available Boolean  @default(true)
  createdAt    DateTime @default(now())
}

// ==============================
// 3. INTERACTIONS (CHAT & REVIEWS)
// ==============================

model Conversation {
  id        Int     @id @default(autoincrement())
  bookingId Int     @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  messages  Message[]
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId Int
  sender   User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  message_text String
  sent_at      DateTime @default(now())
}

model Review {
  id        Int     @id @default(autoincrement())
  bookingId Int     @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)

  rating    Int
  comment   String?
  reply     String? // Vendor Reply
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



model Promotion {
  id          Int      @id @default(autoincrement())
  vendorId    Int
  vendor      User     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  title       String
  description String
  discount    Float
  start_date  DateTime
  end_date    DateTime
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  is_read   Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
}

model Feedback {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  title     String
  message   String
  category  String
  createdAt DateTime @default(now())
}
